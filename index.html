<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SERVER: Survival Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- UI Overlay: Top Bar -->
    <div class="absolute top-0 left-0 w-full h-full pointer-events-none">

        <!-- Stats Panel (Top Left) -->
        <div id="statsPanel" class="absolute top-4 left-4 glass-panel rounded-xl p-5 w-80 pointer-events-auto">
            <div class="flex justify-between items-end mb-3 border-b border-gray-700 pb-2">
                <h1 class="text-2xl font-bold text-red-500 tracking-widest animate-pulse">SURVIVAL</h1>
                <span class="text-xs text-gray-500 font-mono">v2.1</span>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">BUDGET</span>
                    <span id="money-display"
                        class="text-green-400 font-mono text-xl font-bold transition-colors duration-300">$500</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-gray-500">Upkeep Cost</span>
                    <span id="upkeep-display" class="text-red-400 font-mono">-$0.00/s</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">REPUTATION</span>
                    <div class="w-32 h-3 bg-gray-800 rounded-full overflow-hidden relative">
                        <div id="rep-bar" class="h-full bg-yellow-500 transition-all duration-500" style="width: 100%">
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center pt-1">
                    <span class="text-gray-400 text-sm">LOAD (RPS)</span>
                    <span id="rps-display" class="text-blue-300 font-mono text-sm">0.0 req/s</span>
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-gray-700 mt-2">
                    <span class="text-gray-300 font-bold text-lg">TOTAL SCORE</span>
                    <span id="total-score-display" class="text-white font-mono text-2xl font-bold">0</span>
                </div>
            </div>
        </div>

        <!-- Score Details Panel (Top Right) -->
        <div id="detailsPanel" class="absolute top-4 right-4 glass-panel rounded-xl p-4 w-60 pointer-events-auto">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 border-b border-gray-700 pb-1">
                Traffic Score Details</h3>
            <div class="space-y-1 text-sm font-mono">
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">WEB (S3)</span>
                    <span id="score-web" class="text-gray-300">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">API (RDS)</span>
                    <span id="score-api" class="text-gray-300">0</span>
                </div>
                <div class="flex justify-between items-center pt-1 border-t border-gray-800">
                    <span class="text-purple-300 font-bold">WAF REFLECTED</span>
                    <span id="score-fraud" class="text-purple-300">0</span>
                </div>
            </div>
        </div>


        <!-- Time Control Panel (Top Center) -->
        <div
            class="absolute top-4 left-1/2 transform -translate-x-1/2 glass-panel rounded-xl p-2 pointer-events-auto flex gap-2">
            <button onclick="restartGame()" id="btn-restart"
                class="time-btn w-10 h-10 rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-red-500 hover:text-red-400 flex items-center justify-center mr-2"
                title="Restart Game">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
            </button>
            <div class="w-px bg-gray-700 mx-1"></div>
            <button onclick="setTimeScale(0)" id="btn-pause"
                class="time-btn w-10 h-10 rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 flex items-center justify-center">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
            </button>
            <button onclick="setTimeScale(1)" id="btn-play"
                class="time-btn active w-10 h-10 rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 flex items-center justify-center">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
            </button>
            <button onclick="setTimeScale(3)" id="btn-fast"
                class="time-btn w-10 h-10 rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 flex items-center justify-center relative">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z" />
                </svg>
            </button>
        </div>

        <!-- Objective Panel (Bottom Left) -->
        <div id="objectivesPanel"
            class="absolute bottom-24 left-4 glass-panel rounded-xl p-4 pointer-events-auto max-w-xs">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Current Objectives</h3>
                <span
                    class="text-[10px] bg-red-900/50 px-2 py-0.5 rounded text-red-400 border border-red-800 animate-pulse">LIVE</span>
            </div>
            <ul class="text-xs text-gray-300 space-y-2 font-mono">
                <li class="flex items-center">
                    <span class="w-2 h-2 rounded-full bg-red-500 mr-2 animate-pulse"></span>
                    Survive Endless Traffic
                </li>
                <li id="goal-web" class="flex items-center">
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                    Route WEB traffic to S3
                </li>
                <li id="goal-api" class="flex items-center">
                    <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span>
                    Route API traffic to RDS
                </li>
                <li id="goal-waf" class="flex items-center">
                    <span class="w-2 h-2 rounded-full bg-purple-500 mr-2"></span>
                    Block FRAUD traffic with WAF
                </li>
            </ul>
        </div>
    </div>

    <!-- UI Overlay: Bottom Toolbar -->
    <div class="absolute bottom-6 left-0 w-full z-10 pointer-events-none flex justify-center">
        <div class="glass-panel rounded-2xl p-2 pointer-events-auto flex items-center gap-2 shadow-2xl">



            <!-- Help Button -->
            <button id="tool-help"
                class="service-btn bg-gray-700 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center mr-2 border border-gray-600"
                onclick="showOnboarding()">
                <div class="text-xl">?</div>
                <span class="text-[9px] font-bold mt-1 uppercase">Help</span>
            </button>

            <!-- Mute Button -->
            <button id="tool-mute"
                class="service-btn bg-gray-700 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-gray-600"
                onclick="toggleMute()">
                <div class="text-xl" id="mute-icon">üîä</div>
                <span class="text-[9px] font-bold mt-1 uppercase">Sound</span>
            </button>

            <!-- Tools -->
            <div class="flex gap-1 pr-4 border-r border-gray-700">
                <button id="tool-select"
                    class="service-btn active bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent"
                    onclick="setTool('select')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122">
                        </path>
                    </svg>
                    <span class="text-[10px] uppercase">Select</span>
                </button>

                <button id="tool-connect"
                    class="service-btn bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent"
                    onclick="setTool('connect')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                        </path>
                    </svg>
                    <span class="text-[10px] uppercase">Link</span>
                </button>

                <button id="tool-delete"
                    class="service-btn bg-red-900/30 text-red-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent hover:bg-red-900/50"
                    onclick="setTool('delete')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                    <span class="text-[10px] uppercase">Demolish</span>
                </button>
            </div>

            <!-- Shop -->
            <div class="flex gap-2 pl-2">
                <!-- WAF -->
                <button id="tool-waf"
                    class="service-btn bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent group relative overflow-hidden"
                    onclick="setTool('waf')">
                    <div
                        class="absolute top-0 right-0 bg-green-900/80 text-green-400 text-[9px] px-1 rounded-bl font-mono">
                        $50</div>
                    <div class="w-4 h-4 bg-purple-500 rounded-sm mb-1 shadow-[0_0_10px_rgba(168,85,247,0.6)]"></div>
                    <span class="text-[10px] font-bold mt-1">WAF</span>
                    <span class="text-[8px] text-gray-400">Sec</span>
                </button>

                <button id="tool-alb"
                    class="service-btn bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent group relative overflow-hidden"
                    onclick="setTool('alb')">
                    <div
                        class="absolute top-0 right-0 bg-green-900/80 text-green-400 text-[9px] px-1 rounded-bl font-mono">
                        $50</div>
                    <div class="w-4 h-4 bg-blue-500 rounded-sm mb-1 shadow-[0_0_10px_rgba(59,130,246,0.6)]"></div>
                    <span class="text-[10px] font-bold mt-1">ALB</span>
                    <span class="text-[8px] text-gray-400">Load</span>
                </button>

                <button id="tool-lambda"
                    class="service-btn bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent group relative overflow-hidden"
                    onclick="setTool('lambda')">
                    <div
                        class="absolute top-0 right-0 bg-green-900/80 text-green-400 text-[9px] px-1 rounded-bl font-mono">
                        $100</div>
                    <div class="w-4 h-4 bg-orange-500 rounded-full mb-1 shadow-[0_0_10px_rgba(249,115,22,0.6)]"></div>
                    <span class="text-[10px] font-bold mt-1">EC2</span>
                    <span class="text-[8px] text-gray-400">Comp</span>
                </button>

                <button id="tool-db"
                    class="service-btn bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent group relative overflow-hidden"
                    onclick="setTool('db')">
                    <div
                        class="absolute top-0 right-0 bg-green-900/80 text-green-400 text-[9px] px-1 rounded-bl font-mono">
                        $200</div>
                    <div
                        class="w-4 h-4 bg-red-600 rounded-sm mb-1 shadow-[0_0_10px_rgba(220,38,38,0.6)] border-b-2 border-red-800">
                    </div>
                    <span class="text-[10px] font-bold mt-1">RDS</span>
                    <span class="text-[8px] text-gray-400">Data</span>
                </button>

                <!-- S3 -->
                <button id="tool-s3"
                    class="service-btn bg-gray-800 text-gray-200 p-2 rounded-lg w-16 h-16 flex flex-col items-center justify-center border border-transparent group relative overflow-hidden"
                    onclick="setTool('s3')">
                    <div
                        class="absolute top-0 right-0 bg-green-900/80 text-green-400 text-[9px] px-1 rounded-bl font-mono">
                        $25</div>
                    <div class="w-4 h-4 bg-emerald-500 rounded-full mb-1 shadow-[0_0_10px_rgba(16,185,129,0.6)]"></div>
                    <span class="text-[10px] font-bold mt-1">S3</span>
                    <span class="text-[8px] text-gray-400">Store</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Hover Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Game Canvas -->
    <div id="canvas-container"></div>



    <!-- End/Next Level Modal -->
    <div id="modal"
        class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-2xl text-center max-w-md border border-gray-600">
            <h2 id="modal-title" class="text-4xl font-bold mb-4 text-white font-mono tracking-tighter">SYSTEM FAILURE
            </h2>
            <div class="h-px w-full bg-gray-700 mb-6"></div>
            <p id="modal-desc" class="text-gray-300 mb-8 text-sm leading-relaxed">Infrastructure collapsed.</p>
            <div class="flex justify-center gap-4">
                <button onclick="restartGame()"
                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-sm">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal"
        class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-md"
        style="display: none;">
        <div
            class="glass-panel p-8 rounded-2xl max-w-2xl w-full border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.2)] relative">
            <!-- Close Button -->
            <button onclick="closeOnboarding()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <!-- Step 1: Welcome -->
            <div id="step-1" class="onboarding-step active">
                <div class="text-center mb-8">
                    <div class="inline-block p-4 rounded-full bg-blue-900/30 mb-4 border border-blue-500/50">
                        <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-2 tracking-wide">WELCOME ARCHITECT</h2>
                    <p class="text-gray-400 text-lg">Your mission: Design a scalable cloud infrastructure to survive the
                        traffic spike.</p>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 text-center">
                        <div class="text-2xl mb-2">üí∞</div>
                        <h3 class="text-white font-bold text-sm">Manage Budget</h3>
                        <p class="text-xs text-gray-400 mt-1">Services cost money to build and maintain.</p>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 text-center">
                        <div class="text-2xl mb-2">üõ°Ô∏è</div>
                        <h3 class="text-white font-bold text-sm">Defend</h3>
                        <p class="text-xs text-gray-400 mt-1">Block malicious traffic before it crashes your system.</p>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 text-center">
                        <div class="text-2xl mb-2">üìà</div>
                        <h3 class="text-white font-bold text-sm">Scale</h3>
                        <p class="text-xs text-gray-400 mt-1">Handle increasing Request Per Second (RPS) load.</p>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="nextOnboardingStep(2)"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition flex items-center">
                        Next: Traffic Types <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Step 2: Traffic -->
            <div id="step-2" class="onboarding-step">
                <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-2">KNOW YOUR TRAFFIC</h2>
                <div class="space-y-4 mb-8">
                    <div class="flex items-center bg-gray-800/30 p-3 rounded-lg border border-green-900/50">
                        <div
                            class="w-4 h-4 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)] mr-4 shrink-0">
                        </div>
                        <div>
                            <h3 class="text-green-400 font-bold">WEB Traffic</h3>
                            <p class="text-sm text-gray-400">Must be routed to <span
                                    class="text-emerald-400 font-bold">S3 Storage</span>.</p>
                        </div>
                    </div>
                    <div class="flex items-center bg-gray-800/30 p-3 rounded-lg border border-orange-900/50">
                        <div
                            class="w-4 h-4 rounded-full bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.6)] mr-4 shrink-0">
                        </div>
                        <div>
                            <h3 class="text-orange-400 font-bold">API Traffic</h3>
                            <p class="text-sm text-gray-400">Must be routed to <span class="text-red-500 font-bold">RDS
                                    Database</span>.</p>
                        </div>
                    </div>
                    <div class="flex items-center bg-gray-800/30 p-3 rounded-lg border border-purple-900/50">
                        <div
                            class="w-4 h-4 rounded-full bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.6)] mr-4 shrink-0">
                        </div>
                        <div>
                            <h3 class="text-purple-400 font-bold">FRAUD Traffic</h3>
                            <p class="text-sm text-gray-400">Must be BLOCKED by <span
                                    class="text-purple-400 font-bold">WAF Firewall</span>. Do not let it pass!</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button onclick="nextOnboardingStep(1)"
                        class="text-gray-400 hover:text-white font-bold py-2 px-4">Back</button>
                    <button onclick="nextOnboardingStep(3)"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition flex items-center">
                        Next: Controls <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Step 3: Controls & Examples -->
            <div id="step-3" class="onboarding-step">
                <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-2">HOW TO CONNECT</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Example 1: Web Flow -->
                    <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                        <h3 class="text-green-400 font-bold mb-4 text-center text-sm">WEB TRAFFIC FLOW</h3>
                        <div class="flow-container">
                            <div class="flow-node border-gray-500" title="Internet">üåê</div>
                            <div class="flow-line">
                                <div class="flow-packet bg-green-400"></div>
                            </div>
                            <div class="flow-node border-blue-500" title="Load Balancer">‚öñÔ∏è</div>
                            <div class="flow-line">
                                <div class="flow-packet bg-green-400" style="animation-delay: 0.75s"></div>
                            </div>
                            <div class="flow-node border-emerald-500" title="S3 Storage">üíæ</div>
                        </div>
                        <p class="text-xs text-gray-400 text-center">Route <span class="text-green-400">WEB</span>
                            traffic to <span class="text-emerald-400">S3</span> via Load Balancer.</p>
                    </div>

                    <!-- Example 2: API Flow -->
                    <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                        <h3 class="text-orange-400 font-bold mb-4 text-center text-sm">API TRAFFIC FLOW</h3>
                        <div class="flow-container">
                            <div class="flow-node border-gray-500">üåê</div>
                            <div class="flow-line">
                                <div class="flow-packet bg-orange-400"></div>
                            </div>
                            <div class="flow-node border-orange-500" title="Compute">‚öôÔ∏è</div>
                            <div class="flow-line">
                                <div class="flow-packet bg-orange-400" style="animation-delay: 0.75s"></div>
                            </div>
                            <div class="flow-node border-red-500" title="Database">üóÑÔ∏è</div>
                        </div>
                        <p class="text-xs text-gray-400 text-center">Route <span class="text-orange-400">API</span>
                            traffic to <span class="text-red-400">DB</span> via Compute.</p>
                    </div>
                </div>

                <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30 text-center mb-6">
                    <p class="text-blue-200 text-sm">
                        <span class="key-badge">LINK TOOL</span> : Click <strong>Source</strong> then
                        <strong>Destination</strong> to connect.
                    </p>
                </div>

                <div class="flex justify-between">
                    <button onclick="nextOnboardingStep(2)"
                        class="text-gray-400 hover:text-white font-bold py-2 px-4">Back</button>
                    <button onclick="closeOnboarding()"
                        class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase">
                        START SIMULATION
                    </button>
                </div>
            </div>
        </div>

        <script src="src/config.js"></script>
        <script src="src/state.js"></script>
        <script src="src/entities/Request.js"></script>
        <script src="src/entities/Service.js"></script>
        <script src="src/services/SoundService.js"></script>
        <script src="game.js"></script>
</body>

</html>